# DB モデリング５

## 課題１

- 記事リストと同じカラムを持つ履歴テーブルを用意するパターン
  - 更新していないカラムも含めてレコードを履歴として INSERT
  - 一度に多くのカラムを更新する場合に有効
  - 各履歴でのスナップショットも取得しやすいと考える
  - `ARTICLE-LIST`には最新記事のレコードのみを持たせる
    - 更新時は、UPDATE するパターンと、DELETE → INSERT するパターンの 2 通り
  - `AUTHOR-ARTICLE-RELATIONSHIP`の`editor_id`は、作成者・更新者の両方を含む
    - 一番古い編集日時 = ドキュメント作成日時 という考え方
    - `creator_id`, `updator_id`という分け方を考えたが、`creator_id`が繰り返されるので`editor_id`にした

[![課題１のER図](https://mermaid.ink/img/pako:eNrVlM1qwkAQx19l2XPzAt6kWgyVKmoPhYCs2VUDyUaSTUFUKIoiLQVP_cAeeqgglJYWhNKC-DCa1L5FVxOT-EEpvRVyWGZ-85_5TzapQVnHBEYgMWIKKhlIk6hEo8e5RCojJMVsDtTrgqDXgBeKZnLifjIuZOLJaE5MHWUTYhpEQIGoOi2ZeabzYg_5Y_UP5ErMyyV4g1TmhAvIOmVIoebm7DWJAmBZCgb8SR8CCX6-Db_6nflZW4xJcJE9RYZcRgagSCPhvN27XACNkOTOmYIWBCtMN_L8dLCz0xJCBlNklfjUfHgz-7hwEbdXeHvb84f5YHimMJX42WlzMm0-TFvdaetxnVvsiVDmk3anbT-_uwxTNGIypFWAbBDECM6jAJyN75xuz7keOLfNTdyq4E3c6Y-cq5cAX3O2em3b5uzXgfM0-vW-_o__lRmMOVeo-m5cwy4duimBtlux0Pfp-WRsn9-v7RbuQY0YGlIw_5CXa5UgKxONSDDCj5gUkaWyJcxRd9748rbCSBGpJtmDyGJ6tkplP-BS3j_Biza-AYHPsOw)](https://mermaid.live/edit#pako:eNrVlM1qwkAQx19l2XPzAt6kWgyVKmoPhYCs2VUDyUaSTUFUKIoiLQVP_cAeeqgglJYWhNKC-DCa1L5FVxOT-EEpvRVyWGZ-85_5TzapQVnHBEYgMWIKKhlIk6hEo8e5RCojJMVsDtTrgqDXgBeKZnLifjIuZOLJaE5MHWUTYhpEQIGoOi2ZeabzYg_5Y_UP5ErMyyV4g1TmhAvIOmVIoebm7DWJAmBZCgb8SR8CCX6-Db_6nflZW4xJcJE9RYZcRgagSCPhvN27XACNkOTOmYIWBCtMN_L8dLCz0xJCBlNklfjUfHgz-7hwEbdXeHvb84f5YHimMJX42WlzMm0-TFvdaetxnVvsiVDmk3anbT-_uwxTNGIypFWAbBDECM6jAJyN75xuz7keOLfNTdyq4E3c6Y-cq5cAX3O2em3b5uzXgfM0-vW-_o__lRmMOVeo-m5cwy4duimBtlux0Pfp-WRsn9-v7RbuQY0YGlIw_5CXa5UgKxONSDDCj5gUkaWyJcxRd9748rbCSBGpJtmDyGJ6tkplP-BS3j_Biza-AYHPsOw)

## 課題２

- アプリケーションに利用されるような履歴データ（履歴を一覧表示したり、履歴を復元する）は、データベースでの保存する必要がある。一方で、後から履歴を分析したい場合には、前者のように最適化された履歴テーブルまでは持たさなくても、アプリケーション側で計測ログを仕込んだりすることでカバーできると考える。つまり、分析用のデータは別のサービスに集積させることで、アプリケーションで使用しない余計なデータを切り分ける
  - [履歴テーブルについて](https://user-first.ikyu.co.jp/entry/history-table)の技術ブログの判断基準を参照
- 異なるアプローチ１：記事テーブル自体を履歴テーブルとして扱うパターン
  - [変更履歴を持つテーブルの設計](https://qiita.com/ak-ymst/items/2e8e92f212c807bb09a1)の Qiita の「その 1 記事テーブルにバージョン番号を持たせる方法」を参照
  - 記事グループ ID + verison の複合主キー
    - 同じ記事の場合、同じ記事クループ ID を持つ
  - 記事の最終更新日時は, 最新 version のレコードの updated_at で判断

[![課題２のER図１](https://mermaid.ink/img/pako:eNqd0m9LwkAcB_C3ctxj9wZ8Jmk4khRdzwZybacdbHdy3oRQIRyKEIGPsrCHRUIQQkF_KHox02XvottmulmPgj047j6_32_77trQYCaGaYh5lqA6R7ZOdZo50PLFslJQKxrodBSFtcFqK1PW1J1CTinnChlNLe5X8moJpMEhthitN6uCyeIV-V91cnhbpwA4DjGBfEp7QIefT9OvyWB50lezOgxOW4gbR4gDimwcP1-MzgLQjbX8c_xmhMExEoxX5XI3GDV_v_KHo9ioUDkNM6H8yaN_PttWiAtiWHitltOL-etpRKJXiqf0-zPjfqtlnTOnETT-UV5v5rl3nvvmueNERQvzJmF0A91RoHrPnnvruQ_J_AQRFo71_PB61547lJ2TzmBUYCrWcjHoL-5fIiOIjZsC2Y0oS2xW0QZGcfrjG_-yt83DUJM8ynXDZWowBW3MbURMeWHDzHQojrCNdZiWSxPXkGOJEEsa9cyZRP4tmK4hq4lTEDmCVY6psd6I1Orur3a732AXPS0)](https://mermaid.live/edit#pako:eNqd0m9LwkAcB_C3ctxj9wZ8Jmk4khRdzwZybacdbHdy3oRQIRyKEIGPsrCHRUIQQkF_KHox02XvottmulmPgj047j6_32_77trQYCaGaYh5lqA6R7ZOdZo50PLFslJQKxrodBSFtcFqK1PW1J1CTinnChlNLe5X8moJpMEhthitN6uCyeIV-V91cnhbpwA4DjGBfEp7QIefT9OvyWB50lezOgxOW4gbR4gDimwcP1-MzgLQjbX8c_xmhMExEoxX5XI3GDV_v_KHo9ioUDkNM6H8yaN_PttWiAtiWHitltOL-etpRKJXiqf0-zPjfqtlnTOnETT-UV5v5rl3nvvmueNERQvzJmF0A91RoHrPnnvruQ_J_AQRFo71_PB61547lJ2TzmBUYCrWcjHoL-5fIiOIjZsC2Y0oS2xW0QZGcfrjG_-yt83DUJM8ynXDZWowBW3MbURMeWHDzHQojrCNdZiWSxPXkGOJEEsa9cyZRP4tmK4hq4lTEDmCVY6psd6I1Orur3a732AXPS0)

- 🔞 異なるアプローチ２：記事テーブルのカラム一つひとつの変更を履歴として追うパターン
  - SQL アンチパターンの一つである、EAV (エンティティ・アトリビュート・バリュー) にあたる可能性
  - [Design a Table to Keep Historical Changes in Database](https://dev.to/zhiyueyi/design-a-table-to-keep-historical-changes-in-database-10fn?signin=true)を参照
  - 更新したカラムに関するレコードのみを履歴として insert
  - 一度に更新するカラムの数が少ないほど有効
  - 更新されたカラムだけ保存するので、履歴テーブルに余計なカラムを持たない

[![課題２のER図２](https://mermaid.ink/img/pako:eNqdk9FK3EAUhl9lmGv3BfZu6W4xdKmyG-8Cy5g5qwPJRLITi6yC3eCibQWvbEUvvFhBEUVBEKXWhxmTbt-ik500yUYpIszFMOc7c_7zz5k-tj0KuIrBrzOy5BPX4havLZizc61K02ibaH29UvH6KD2qtUzjXbNRaTWaNdOY-9ieNeZRFS2C4_GlXkd4KjlF3pj9H_LfZWmstlA3TJVue1wQxntl5X2LIxQEjCK15j8gC_--Pf1zOBxvbhl1CyfRVeLby8RHnLhQjEd7uwmwUbjyRUV5CaBMeH5H7d6_WGkCEV8w24GMGp_-eLr_qhFdq-jdc_1FPhcvmHAgi8rBoxyMZLgtw_NpLvEJuMjIaLgVXd5pRjAXeoK4K8j2gQigHZKDTw9H8fZe_P0kPhiU8WCFlvH48Cbev8rxqc70oz1vLbo-iS9uXu1W3lWXgUPz7sOhDH_KcF91Lz9fysG5DM9keDyd4zm0s0qcIHEtGu0owdHOrsKjzVFpLuBTGfz1rQhqoZQqBxbXMqW6Ge1DYQZy13RG4lxGjx8foi_HU67hGeyC7xJG1QedWGZhsQwuWLiqthS6JHDEBFaofonGZA5xtUucHsxgEgivvcbt7EBT6V9PTzf-AhbIn7M)](https://mermaid.live/edit#pako:eNqdk9FK3EAUhl9lmGv3BfZu6W4xdKmyG-8Cy5g5qwPJRLITi6yC3eCibQWvbEUvvFhBEUVBEKXWhxmTbt-ik500yUYpIszFMOc7c_7zz5k-tj0KuIrBrzOy5BPX4havLZizc61K02ibaH29UvH6KD2qtUzjXbNRaTWaNdOY-9ieNeZRFS2C4_GlXkd4KjlF3pj9H_LfZWmstlA3TJVue1wQxntl5X2LIxQEjCK15j8gC_--Pf1zOBxvbhl1CyfRVeLby8RHnLhQjEd7uwmwUbjyRUV5CaBMeH5H7d6_WGkCEV8w24GMGp_-eLr_qhFdq-jdc_1FPhcvmHAgi8rBoxyMZLgtw_NpLvEJuMjIaLgVXd5pRjAXeoK4K8j2gQigHZKDTw9H8fZe_P0kPhiU8WCFlvH48Cbev8rxqc70oz1vLbo-iS9uXu1W3lWXgUPz7sOhDH_KcF91Lz9fysG5DM9keDyd4zm0s0qcIHEtGu0owdHOrsKjzVFpLuBTGfz1rQhqoZQqBxbXMqW6Ge1DYQZy13RG4lxGjx8foi_HU67hGeyC7xJG1QedWGZhsQwuWLiqthS6JHDEBFaofonGZA5xtUucHsxgEgivvcbt7EBT6V9PTzf-AhbIn7M)
