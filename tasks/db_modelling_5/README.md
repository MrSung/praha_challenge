# DB モデリング５

## 課題１

- 記事を更新するタイミングで、編集者と記事を結びつけて、履歴テーブルにレコードを INSERT する
- `article-edited-history`の`editor_id`は、作成者・更新者の両方を含む（一番古い編集日時 = ドキュメント作成日時）

[![課題１のER図](https://mermaid.ink/img/pako:eNqNk81Kw0AQx19l2XPzAjlXQbwIXgNlzU7NQj7KZiOEpiAtLQURevKDerRQEEWhIAriw6SJ9S3cZNsk_RCFPQwzv__w39nZNjY9CljHwOuMnHLiGK7hkkBYHkdRpGleGxEumGmDBpQJoEhHWeBLSuV_xZjfUHGBrmqZIoo2FJrFfOHxUCot4ldstA0XoSBgFMlzdIgM_PU6_R4PFuf9g7qBs-oZ4aZFOHKJA9V6MrrMgE7ebd1D2TVLeLwho_2dzXNoqS6oxfRm_n6hkGr7HW6raGlVMGFDUY27n3H3Pu4N497DOmd6rgBXFGQy6CdPb4oRzAFfEKeFTA5E3qqRZQp0_nGXDkfp9SS97W4KghbdFqTjWXr1XAp2zK14pe17Ji-T9HH276mtEEqljZNwg1FWKq9QWleKv4zjGnaAO4RRud25WQMLCxwwsC5DCk0S2CKHJarGsZdvAtabxPahhuX-ecehaxYJRS0_yjLb-QEwAlh7)](https://mermaid.live/edit#pako:eNqNk81Kw0AQx19l2XPzAjlXQbwIXgNlzU7NQj7KZiOEpiAtLQURevKDerRQEEWhIAriw6SJ9S3cZNsk_RCFPQwzv__w39nZNjY9CljHwOuMnHLiGK7hkkBYHkdRpGleGxEumGmDBpQJoEhHWeBLSuV_xZjfUHGBrmqZIoo2FJrFfOHxUCot4ldstA0XoSBgFMlzdIgM_PU6_R4PFuf9g7qBs-oZ4aZFOHKJA9V6MrrMgE7ebd1D2TVLeLwho_2dzXNoqS6oxfRm_n6hkGr7HW6raGlVMGFDUY27n3H3Pu4N497DOmd6rgBXFGQy6CdPb4oRzAFfEKeFTA5E3qqRZQp0_nGXDkfp9SS97W4KghbdFqTjWXr1XAp2zK14pe17Ji-T9HH276mtEEqljZNwg1FWKq9QWleKv4zjGnaAO4RRud25WQMLCxwwsC5DCk0S2CKHJarGsZdvAtabxPahhuX-ecehaxYJRS0_yjLb-QEwAlh7)

## 課題２

- アプリケーションに利用されるような履歴データ（履歴を一覧表示したり、履歴を復元する）は、データベースでの保存する必要がある。一方で、後から履歴を分析したい場合には、前者のように最適化された履歴テーブルまでは持たさなくても、アプリケーション側で計測ログを仕込んだりすることでカバーできると考える。つまり、分析用のデータは別のサービスに集積させることで、アプリケーションで使用しない余計なデータを切り分ける
  - [履歴テーブルについての技術ブログ](https://user-first.ikyu.co.jp/entry/history-table)の判断基準を参照

---

- 異なるアプローチ１：記事テーブル自体を履歴テーブルとして扱うパターン
  - [変更履歴を持つテーブルの設計の Qiita](https://qiita.com/ak-ymst/items/2e8e92f212c807bb09a1)の「その 1 記事テーブルにバージョン番号を持たせる方法」を参照
  - 記事グループ ID + `verison` の複合主キー
    - 同じ記事の場合、同じ記事クループ ID を持つ
  - 記事の最終更新日時は、最新 `version` のレコードの `updated_time` で判断

[![課題２のER図１](https://mermaid.ink/img/pako:eNqNkt9KwzAUh18l5Nq9QK-nIN4I3hZGbM62QJuMNB3INpCWjYEIu3LKvFQcCDJQ8A-KD5OtzrcwbWfXzl0IuQjnfL-v5eR0sCMoYAuDrDLSkMSzuc1JoJpCom63UhEdRKRijgsVoEwBRRY6Blfwhl9TwqBZ819sLu7YHKEgYBSZc3iAbPz1PP2eDJan_f2qjZNum0inSSTixINifzE6T4Beait_bG1NCkLWzG1vqzyFVumcWk4v529nGVLUb_nbIrpha0gRtBLnL6XDmY7udfSuo3Ep0QbpM8HXYDRKqPBFR3c6eiyPQTHlQsH5qcMbHQ2Nucw5givgKicXg_7i4TVjFPPAV8RrIUcCMROrJZUcnX9cx8NRPL6Nr8LNQNCifwPx5Cm-mK0DZmh4B3sgPcKoWal0bjZWTfDAxpa5UqiTwFUpbNDMups-FrbqxPVhB5sVEUcn3MkLGbXazlW19wOGUCWs)](https://mermaid.live/edit#pako:eNqNkt9KwzAUh18l5Nq9QK-nIN4I3hZGbM62QJuMNB3INpCWjYEIu3LKvFQcCDJQ8A-KD5OtzrcwbWfXzl0IuQjnfL-v5eR0sCMoYAuDrDLSkMSzuc1JoJpCom63UhEdRKRijgsVoEwBRRY6Blfwhl9TwqBZ819sLu7YHKEgYBSZc3iAbPz1PP2eDJan_f2qjZNum0inSSTixINifzE6T4Beait_bG1NCkLWzG1vqzyFVumcWk4v529nGVLUb_nbIrpha0gRtBLnL6XDmY7udfSuo3Ep0QbpM8HXYDRKqPBFR3c6eiyPQTHlQsH5qcMbHQ2Nucw5givgKicXg_7i4TVjFPPAV8RrIUcCMROrJZUcnX9cx8NRPL6Nr8LNQNCifwPx5Cm-mK0DZmh4B3sgPcKoWal0bjZWTfDAxpa5UqiTwFUpbNDMups-FrbqxPVhB5sVEUcn3MkLGbXazlW19wOGUCWs)

- 🔞 異なるアプローチ２：記事テーブルのカラム一つひとつの変更を履歴として追うパターン
  - [Design a Table to Keep Historical Changes in Database](https://dev.to/zhiyueyi/design-a-table-to-keep-historical-changes-in-database-10fn?signin=true)を参照
  - SQL アンチパターンの一つである、EAV (エンティティ・アトリビュート・バリュー) にあたる
    - [SQL アンチパターン Entity Attribute Value の Qiita](https://qiita.com/fktnkit/items/0ff462640e00deecfc6d)を参照

[![課題２のER図２](https://mermaid.ink/img/pako:eNqNk8tKw0AUhl9lmLV9ga5VEDeC20AZM6dmIBeZTCqlFWqDxaKCKy_owkUFRSwKBVG8PMyYWN_CSabm0qoIWRzO-f7DP39mWtj0KOAqBj7PyDonjuEaLgmE5XHUblcqXgsRLphpQwUoE0BRFSWFryjd_xVjfk3XGfo9SxTtdqYggWpXLOYLjzeV0CJ-wUXLcBEKAkaR-laWkYE_Hq4-z3rjzs7SvIGTaYNw0yIcucSB4jw6PEiArXRb2UK-NWl4vKaqxR-Xp9BEnVHjq5P3pz2NFNf_4LaI5lYFEzZkU9l9k92BDHdleFPmTM8V4IqMjHo70fBRM4I54AvibCCTA1GnqiWdDH1_OY93D-Pjy_i0Oy0INuisID4bxUd3uaCUW_knzR4zur-Mb0f_Di0_YZ2BTfMkwp4Mn2V4pJKQ20PZvZHhtQwvyhrPprUGsYPEezToK-NR_0DhUWcwdSNgcxp83S-C2iilKou15pRTnUfhKuT5aUWS4V_p4TnsAHcIo-qFpZEZWFjggIGrqqRQJ4EtUlih-p8spNcRV-vE9mEOq0fgrTZdM2toavJYJ92tLw3fmlc)](https://mermaid.live/edit#pako:eNqNk8tKw0AUhl9lmLV9ga5VEDeC20AZM6dmIBeZTCqlFWqDxaKCKy_owkUFRSwKBVG8PMyYWN_CSabm0qoIWRzO-f7DP39mWtj0KOAqBj7PyDonjuEaLgmE5XHUblcqXgsRLphpQwUoE0BRFSWFryjd_xVjfk3XGfo9SxTtdqYggWpXLOYLjzeV0CJ-wUXLcBEKAkaR-laWkYE_Hq4-z3rjzs7SvIGTaYNw0yIcucSB4jw6PEiArXRb2UK-NWl4vKaqxR-Xp9BEnVHjq5P3pz2NFNf_4LaI5lYFEzZkU9l9k92BDHdleFPmTM8V4IqMjHo70fBRM4I54AvibCCTA1GnqiWdDH1_OY93D-Pjy_i0Oy0INuisID4bxUd3uaCUW_knzR4zur-Mb0f_Di0_YZ2BTfMkwp4Mn2V4pJKQ20PZvZHhtQwvyhrPprUGsYPEezToK-NR_0DhUWcwdSNgcxp83S-C2iilKou15pRTnUfhKuT5aUWS4V_p4TnsAHcIo-qFpZEZWFjggIGrqqRQJ4EtUlih-p8spNcRV-vE9mEOq0fgrTZdM2toavJYJ92tLw3fmlc)
