# DB モデリング５

## 課題１

- 記事リストと同じカラムを持つ履歴テーブルを用意するパターン
  - 更新していないカラムも含めてレコードを履歴として insert
  - 一度に多くのカラムを更新する場合に有効
  - 各履歴でのスナップショットも取得しやすいと考える

[![課題１のER図](https://mermaid.ink/img/pako:eNrdlMtKw0AUhl9lmLV9geyKrTRYbEnjQgiUMTO1gWRS0okgVZCWlqIIrrygCxcKgigKBVEofZiaWN_CSSbNpRUXLoUshnO-c_nPmUkH6jYmUILEKRhox0GWRjWa31RLFSVXlmsq2N_P5ewOiEx5RZVXy8WcUiznVbmyUSvJVSCBbWLadKddZzYPjpA_Rv9CzpNFvhIvUFG2eALdpgwZtL3Ye0ejALiugQH_qutAg5-v919Xg9lhXy5oMPDuIkdvIgdQZJG03zs9CYCDVMofe0pK6A5BzHbq_LgWlPoYX_vD01SpkHJbOEP5VyP_7HmRQg4zdJPE1Oz-4uP9WCCipfSQl2Wm-UQjM5hJYu-0O5l2b6e94bT3kOWCcRLKYtIb9L2nN8EwwyJthqyW0EtwHSWgkOyf3_mX3UU8FJ7FhfYEzyibb_e_iJtvFmPObe_Fq_Ve7vzH0dI1SHKLiCB_TM8mY-_oJjM4uAIt4ljIwPwxhzPTIGsSi2hQ4kdMGsg1WQhzVPRbxAa_ilBqILNNViBymV3bo3psEFT0X4isB9_1YrMn)](https://mermaid.live/edit#pako:eNrdlMtKw0AUhl9lmLV9geyKrTRYbEnjQgiUMTO1gWRS0okgVZCWlqIIrrygCxcKgigKBVEofZiaWN_CSSbNpRUXLoUshnO-c_nPmUkH6jYmUILEKRhox0GWRjWa31RLFSVXlmsq2N_P5ewOiEx5RZVXy8WcUiznVbmyUSvJVSCBbWLadKddZzYPjpA_Rv9CzpNFvhIvUFG2eALdpgwZtL3Ye0ejALiugQH_qutAg5-v919Xg9lhXy5oMPDuIkdvIgdQZJG03zs9CYCDVMofe0pK6A5BzHbq_LgWlPoYX_vD01SpkHJbOEP5VyP_7HmRQg4zdJPE1Oz-4uP9WCCipfSQl2Wm-UQjM5hJYu-0O5l2b6e94bT3kOWCcRLKYtIb9L2nN8EwwyJthqyW0EtwHSWgkOyf3_mX3UU8FJ7FhfYEzyibb_e_iJtvFmPObe_Fq_Ve7vzH0dI1SHKLiCB_TM8mY-_oJjM4uAIt4ljIwPwxhzPTIGsSi2hQ4kdMGsg1WQhzVPRbxAa_ilBqILNNViBymV3bo3psEFT0X4isB9_1YrMn)

## 課題２

- アプリケーションに利用されるような履歴データ（履歴を一覧表示したり、履歴を復元する）は、データベースでの保存する必要がある。一方で、後から履歴を分析したい場合には、前者のように最適化された履歴テーブルまでは持たさなくても、アプリケーション側で計測ログを仕込んだりすることでカバーできると考える。つまり、分析用のデータは別のサービスに集積させることで、アプリケーションで使用しない余計なデータを切り分ける

  - [履歴テーブルについて](https://user-first.ikyu.co.jp/entry/history-table)の技術ブログの判断基準を参照

- 異なるアプローチ１：記事テーブル自体を履歴テーブルとして扱うパターン
  - [変更履歴を持つテーブルの設計](https://qiita.com/ak-ymst/items/2e8e92f212c807bb09a1)の Qiita の「その 1 記事テーブルにバージョン番号を持たせる方法」を参照
  - 記事グループ ID + verison の複合主キー
    - 同じ記事の場合、同じ記事クループ ID を持つ
  - 記事の最終更新日時は, 最新 version のレコードの updated_at で判断

[![課題２のER図１](https://mermaid.ink/img/pako:eNqd0m9LwkAcB_C3ctxj9wZ8Jmk4khRdzwZybacdbHdy3oRQIRyKEIGPsrCHRUIQQkF_KHox02XvottmulmPgj047j6_32_77trQYCaGaYh5lqA6R7ZOdZo50PLFslJQKxrodBSFtcFqK1PW1J1CTinnChlNLe5X8moJpMEhthitN6uCyeIV-V91cnhbpwA4DjGBfEp7QIefT9OvyWB50lezOgxOW4gbR4gDimwcP1-MzgLQjbX8c_xmhMExEoxX5XI3GDV_v_KHo9ioUDkNM6H8yaN_PttWiAtiWHitltOL-etpRKJXiqf0-zPjfqtlnTOnETT-UV5v5rl3nvvmueNERQvzJmF0A91RoHrPnnvruQ_J_AQRFo71_PB61547lJ2TzmBUYCrWcjHoL-5fIiOIjZsC2Y0oS2xW0QZGcfrjG_-yt83DUJM8ynXDZWowBW3MbURMeWHDzHQojrCNdZiWSxPXkGOJEEsa9cyZRP4tmK4hq4lTEDmCVY6psd6I1Orur3a732AXPS0)](https://mermaid.live/edit#pako:eNqd0m9LwkAcB_C3ctxj9wZ8Jmk4khRdzwZybacdbHdy3oRQIRyKEIGPsrCHRUIQQkF_KHox02XvottmulmPgj047j6_32_77trQYCaGaYh5lqA6R7ZOdZo50PLFslJQKxrodBSFtcFqK1PW1J1CTinnChlNLe5X8moJpMEhthitN6uCyeIV-V91cnhbpwA4DjGBfEp7QIefT9OvyWB50lezOgxOW4gbR4gDimwcP1-MzgLQjbX8c_xmhMExEoxX5XI3GDV_v_KHo9ioUDkNM6H8yaN_PttWiAtiWHitltOL-etpRKJXiqf0-zPjfqtlnTOnETT-UV5v5rl3nvvmueNERQvzJmF0A91RoHrPnnvruQ_J_AQRFo71_PB61547lJ2TzmBUYCrWcjHoL-5fIiOIjZsC2Y0oS2xW0QZGcfrjG_-yt83DUJM8ynXDZWowBW3MbURMeWHDzHQojrCNdZiWSxPXkGOJEEsa9cyZRP4tmK4hq4lTEDmCVY6psd6I1Orur3a732AXPS0)

- 異なるアプローチ２：記事テーブルのカラム一つひとつの変更を履歴として追うパターン
  - [Design a Table to Keep Historical Changes in Database](https://dev.to/zhiyueyi/design-a-table-to-keep-historical-changes-in-database-10fn?signin=true)を参照
  - 更新したカラムに関するレコードのみを履歴として insert
  - 一度に更新するカラムの数が少ないほど有効
  - 更新されたカラムだけ保存するので、履歴テーブルに余計なカラムを持たない

[![課題２のER図２](https://mermaid.ink/img/pako:eNqdlN9KG0EUxl9lmGvzArkLTcSloUqy3i2EcedEB3ZnZTOrSBRsFoO2FbyyLfbCiwgWqSgIpaXqw4y7pm_R2cx2_6WUUtiLYc7vzDnfN2d2iG2PAq5j8JuMrPvEtbjFG6vm0nKn1ja6JtrdrdW8IUq3Gh3TeNFu1TqtdsM0ll91l4wVVEdr4Hh8fdATnkpOkf_M_gv5-7A01lhtGqZKtz0uCOODaudDiyMUBIwi9a28RBZ-_nr582w83T8wmhZOolvEtzeIjzhxoRiPTo4TYK9w5B87ykvYPhDh-T21XExKPd1_ig9PCqVmVLBJS1R8dhef3lQp4gtmO5BR08sPT9_fakS3VLR4XmaRzzUKJhzIonL0KEcTGR7K8KrMJXYCFxkZjQ-i62-aEcyFgSDuptYLtEdyUEuO31_EH0dVfCa8jGvtOV5Spu92Xlp0exF_uftnt3JVfQYOzdWHYxn-kOGpUi9fX8vRlQw_y_C8nOM5tLdFnCBxLZocqYajo2OFR_uTyvjAdhV8eFcEdaOUKgfWdrJOtZi5Gchd0xmJcxk9fbyP3pyXXMML2AXfJYyqdzyzzMJiA1ywcF0tKfRJ4IgZrFB9Ey3K1Bziep84A1jAJBBed4fb2Yam0l9Curv3CxqEr7s)](https://mermaid.live/edit#pako:eNqdlN9KG0EUxl9lmGvzArkLTcSloUqy3i2EcedEB3ZnZTOrSBRsFoO2FbyyLfbCiwgWqSgIpaXqw4y7pm_R2cx2_6WUUtiLYc7vzDnfN2d2iG2PAq5j8JuMrPvEtbjFG6vm0nKn1ja6JtrdrdW8IUq3Gh3TeNFu1TqtdsM0ll91l4wVVEdr4Hh8fdATnkpOkf_M_gv5-7A01lhtGqZKtz0uCOODaudDiyMUBIwi9a28RBZ-_nr582w83T8wmhZOolvEtzeIjzhxoRiPTo4TYK9w5B87ykvYPhDh-T21XExKPd1_ig9PCqVmVLBJS1R8dhef3lQp4gtmO5BR08sPT9_fakS3VLR4XmaRzzUKJhzIonL0KEcTGR7K8KrMJXYCFxkZjQ-i62-aEcyFgSDuptYLtEdyUEuO31_EH0dVfCa8jGvtOV5Spu92Xlp0exF_uftnt3JVfQYOzdWHYxn-kOGpUi9fX8vRlQw_y_C8nOM5tLdFnCBxLZocqYajo2OFR_uTyvjAdhV8eFcEdaOUKgfWdrJOtZi5Gchd0xmJcxk9fbyP3pyXXMML2AXfJYyqdzyzzMJiA1ywcF0tKfRJ4IgZrFB9Ey3K1Bziep84A1jAJBBed4fb2Yam0l9Curv3CxqEr7s)
